<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kamera Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Bree+Serif&display=swap" rel="stylesheet" />
<style>
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  h1,h2,h3 {
    font-family: 'Bree Serif', serif;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #222;
    border-bottom: 1px solid #333;
  }
  #mainTimer {
    font-size: 64px;
    color: #ff0;
    font-weight: bold;
    user-select: none;
    transition: color 0.5s;
  }
  #settingsToggle {
    background-color: #444;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    user-select: none;
  }
  #settingsPanel {
    position: fixed;
    top: 0; right: 0;
    width: 320px;
    height: 100%;
    background: #222;
    border-left: 2px solid #333;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    padding: 20px;
    overflow-y: auto;
    z-index: 1000;
  }
  #settingsPanel.open {
    transform: translateX(0);
  }
  #settingsPanel input, #settingsPanel select, #settingsPanel button {
    width: 100%;
    margin: 5px 0 10px 0;
    padding: 6px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    overflow: hidden;
  }
  #cameraContainer {
    background-color: #111;
    border-top: 1px solid #333;
    padding: 10px 20px;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
  }
  .category {
    margin-bottom: 10px;
  }
  .category h2 {
    font-size: 18px;
    margin-bottom: 5px;
    user-select: none;
  }
  .camera-row {
    display: flex;
    gap: 10px;
    overflow-x: auto;
  }
  .camera {
    background: #222;
    border-radius: 8px;
    padding: 10px;
    min-width: 160px;
    text-align: center;
    white-space: normal;
    flex-shrink: 0;
    position: relative;
  }
  .camera .remove-btn {
    position: absolute;
    top: 4px;
    right: 6px;
    background: #a00;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 16px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    line-height: 18px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
  }
  .camera .remove-btn:hover {
    background-color: #f33;
  }
  .program { background: #a00; }
  .preview { background: #0a0; }
  .none { background: #444; }
  footer {
    background: #222;
    padding: 5px 15px;
    font-size: 14px;
    color: #ccc;
    text-align: left;
    border-top: 1px solid #333;
    user-select: none;
  }
  footer.ok { color: #0f0; }
  footer.fail { color: #f00; }
  label {
    user-select: none;
  }
/* Vilkkuva ajastin kun loppu */
.blinking {
  color: red;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% {
    opacity: 1;
  }
  50.01%, 100% {
    opacity: 0;
  }
}


  }
  .category-select {
    width: 100%;
    margin-top: 5px;
    margin-bottom: 15px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 6px;
  }
  .category-list {
    max-height: 120px;
    overflow-y: auto;
    margin-bottom: 15px;
    border: 1px solid #555;
    border-radius: 4px;
    background: #222;
    padding: 10px;
  }
  .category-list div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  .category-list div button {
    background: #a00;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: bold;
    border-radius: 4px;
    padding: 0 8px;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .category-list div button:hover {
    background: #f33;
  }
</style>
</head>
<body>
<header>
  <div id="mainTimer">03:00</div>
  <button id="settingsToggle" onclick="toggleSettings()">⚙ Asetukset</button>
</header>

<main>
  <div id="cameraContainer"></div>
</main>

<footer id="status" class="fail">vMix: Ei yhteyttä</footer>

<div id="settingsPanel">
  <h2>Asetukset</h2>
  <label>vMix IP:<br><input type="text" id="vmixIp" /></label>
  <label>Ajastimen pituus (min):<br><input type="number" id="timerLength" min="1" /></label>
  <button onclick="applySettings()">Tallenna asetukset</button>

  <hr />
  <h3>Lisää kamera</h3>
  <label>Nimi:<br><input type="text" id="camName" /></label>
  <label>vMix Input:<br><input type="text" id="camInput" /></label>
  <label>Kategoria:<br>
    <select id="camCategorySelect">
      <option value="">(Ei kategoriaa)</option>
    </select>
  </label>
  <button onclick="addCamera()">Lisää kamera</button>

  <hr />
  <h3>Kategoriat</h3>
  <div class="category-list" id="categoryList"></div>
  <label>Uusi kategoria:<br><input type="text" id="newCategoryName" /></label>
  <button onclick="addCategory()">Lisää kategoria</button>

  <hr />
  <button style="background:#a00; color:#fff;" onclick="resetAll()">Tyhjennä kaikki asetukset</button>
</div>

<script>
  // --- Data ---
  let vmixIp = '127.0.0.1';
  let timerDuration = 180; // sekunteina
  let cameras = [];
  let categories = [];
  let programInput = null;
  let previewInput = null;
  let mainTimer = timerDuration;
  let lastProgramInput = null;

  // --- Utility ---
  function formatTime(s) {
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const sec = (s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
  }

  // --- Load / Save ---
  function saveToStorage() {
    localStorage.setItem('vmixIp', vmixIp);
    localStorage.setItem('timerDuration', timerDuration);
    localStorage.setItem('cameras', JSON.stringify(cameras));
    localStorage.setItem('categories', JSON.stringify(categories));
  }
  function loadFromStorage() {
    vmixIp = localStorage.getItem('vmixIp') || '127.0.0.1';
    timerDuration = parseInt(localStorage.getItem('timerDuration')) || 180;
    cameras = JSON.parse(localStorage.getItem('cameras') || '[]');
    categories = JSON.parse(localStorage.getItem('categories') || '[]');
  }

  // --- Settings Panel ---
  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
      loadSettingsToUI();
    }
  }
  function loadSettingsToUI() {
    document.getElementById('vmixIp').value = vmixIp;
    document.getElementById('timerLength').value = Math.floor(timerDuration / 60);
    populateCategorySelect();
    document.getElementById('camName').value = '';
    document.getElementById('camInput').value = '';
    document.getElementById('camCategorySelect').value = '';
    updateCategoryListUI();
  }
  function applySettings() {
    vmixIp = document.getElementById('vmixIp').value.trim() || '127.0.0.1';
    const len = parseInt(document.getElementById('timerLength').value);
    if (len > 0) timerDuration = len * 60;
    mainTimer = timerDuration;
    saveToStorage();
    updateTimerDisplay();
    alert('Asetukset tallennettu');
  }

  // --- Categories ---
  function populateCategorySelect() {
    const select = document.getElementById('camCategorySelect');
    select.innerHTML = '<option value="">(Ei kategoriaa)</option>';
    for (const cat of categories) {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    }
  }
  function addCategory() {
    const newCat = document.getElementById('newCategoryName').value.trim();
    if (!newCat) {
      alert('Anna kategorian nimi');
      return;
    }
    if (categories.includes(newCat)) {
      alert('Kategoria on jo olemassa');
      return;
    }
    categories.push(newCat);
    saveToStorage();
    populateCategorySelect();
    updateCategoryListUI();
    document.getElementById('newCategoryName').value = '';
  }
  function removeCategory(cat) {
    if (!confirm(`Poistetaanko kategoria '${cat}'? Tämä poistaa myös siihen kuuluvat kamerat.`)) return;
    categories = categories.filter(c => c !== cat);
    // Poistetaan myös kamerat, joiden kategoria oli tämä
    cameras = cameras.filter(cam => cam.category !== cat);
    saveToStorage();
    populateCategorySelect();
    updateCategoryListUI();
    renderCameras();
  }
  function updateCategoryListUI() {
    const div = document.getElementById('categoryList');
    div.innerHTML = '';
    for (const cat of categories) {
      const row = document.createElement('div');
      const label = document.createElement('span');
      label.textContent = cat;
      const btn = document.createElement('button');
      btn.textContent = 'X';
      btn.title = `Poista kategoria '${cat}'`;
      btn.onclick = () => removeCategory(cat);
      row.appendChild(label);
      row.appendChild(btn);
      div.appendChild(row);
    }
  }

  // --- Cameras ---
  function addCamera() {
    const name = document.getElementById('camName').value.trim();
    const input = document.getElementById('camInput').value.trim();
    const category = document.getElementById('camCategorySelect').value || null;
    if (!name || !input) {
      alert('Anna kameran nimi ja vMix Input');
      return;
    }
    // Tarkistetaan ettei sama input ole jo kameralistassa
    if (cameras.find(c => c.input === input)) {
      alert('Tämä vMix Input on jo lisätty kameraksi.');
      return;
    }
    cameras.push({name, input, category});
    saveToStorage();
    renderCameras();
    document.getElementById('camName').value = '';
    document.getElementById('camInput').value = '';
    document.getElementById('camCategorySelect').value = '';
  }
  function removeCamera(input) {
    if (!confirm(`Poistetaanko kamera, jonka vMix Input on '${input}'?`)) return;
    cameras = cameras.filter(c => c.input !== input);
    saveToStorage();
    renderCameras();
  }

  // --- Render Cameras ---
  function renderCameras() {
    const container = document.getElementById('cameraContainer');
    container.innerHTML = '';

    // Järjestetään kamerat kategorioittain
    // Laitetaan ensin kategorioiden kamerat, sitten ne ilman kategoriaa

    // Kategoriat + kamerat
    for (const cat of categories) {
      const cams = cameras.filter(c => c.category === cat);
      if (cams.length === 0) continue;

      const catDiv = document.createElement('div');
      catDiv.className = 'category';

      const title = document.createElement('h2');
      title.textContent = cat;
      catDiv.appendChild(title);

      const camRow = document.createElement('div');
      camRow.className = 'camera-row';

      for (const cam of cams) {
        camRow.appendChild(createCameraElement(cam));
      }

      catDiv.appendChild(camRow);
      container.appendChild(catDiv);
    }

    // Kamerat ilman kategoriaa
    const uncategorized = cameras.filter(c => !c.category);
    if (uncategorized.length > 0) {
      const catDiv = document.createElement('div');
      catDiv.className = 'category';

      const title = document.createElement('h2');
      title.textContent = '(Ei kategoriaa)';
      catDiv.appendChild(title);

      const camRow = document.createElement('div');
      camRow.className = 'camera-row';

      for (const cam of uncategorized) {
        camRow.appendChild(createCameraElement(cam));
      }

      catDiv.appendChild(camRow);
      container.appendChild(catDiv);
    }
  }
  function createCameraElement(cam) {
    const div = document.createElement('div');
    div.className = 'camera none';
    div.dataset.input = cam.input;

    // Kameran nimi ja input
    const title = document.createElement('div');
    title.textContent = cam.name;
    title.style.fontWeight = 'bold';
    div.appendChild(title);

    const inputDiv = document.createElement('div');
    inputDiv.textContent = `Input: ${cam.input}`;
    div.appendChild(inputDiv);

    if (cam.category) {
      const catDiv = document.createElement('div');
      catDiv.textContent = `Kategoria: ${cam.category}`;
      catDiv.style.fontStyle = 'italic';
      catDiv.style.fontSize = '0.85em';
      div.appendChild(catDiv);
    }

    const btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.textContent = '×';
    btn.title = 'Poista kamera';
    btn.onclick = () => removeCamera(cam.input);
    div.appendChild(btn);

    return div;
  }

  // --- Timer ---
  function updateTimerDisplay() {
    const timerDiv = document.getElementById('mainTimer');
    timerDiv.textContent = formatTime(mainTimer);
    if (mainTimer === 0) {
      timerDiv.classList.add('blinking');
    } else {
      timerDiv.classList.remove('blinking');
    }
  }
  function tickTimer() {
    if (mainTimer > 0) {
      mainTimer--;
      updateTimerDisplay();
    }
  }

  // --- vMix API Polling ---
  async function pollVmix() {
    try {
      const res = await fetch(`http://${vmixIp}:8088/api/`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'text/xml');
      const program = xml.querySelector('active');
      const preview = xml.querySelector('preview');
      if (program && preview) {
        lastProgramInput = program.textContent;
        programInput = program.textContent;
        previewInput = preview.textContent;
        updateCameraStatus();
        updateStatus('Yhteys: OK', true);
      } else {
        updateStatus('vMix API vastasi, mutta ei löytynyt tietoja', false);
      }
    } catch (e) {
      updateStatus(`Virhe vMix-yhteydessä: ${e.message}`, false);
    }
  }

  function updateStatus(msg, ok) {
    const status = document.getElementById('status');
    status.textContent = msg;
    status.className = ok ? 'ok' : 'fail';
  }

  // --- Päivitä kameroiden tilat ---
  function updateCameraStatus() {
    // Käydään kamerat läpi ja päivitetään niiden luokka (program, preview, none)
    for (const cam of cameras) {
      const el = document.querySelector(`.camera[data-input="${cam.input}"]`);
      if (!el) continue;
      el.classList.remove('program', 'preview', 'none');
      if (cam.input === programInput) {
        el.classList.add('program');
      } else if (cam.input === previewInput) {
        el.classList.add('preview');
      } else {
        el.classList.add('none');
      }
    }
  }

  // --- Reset all ---
  function resetAll() {
    if (!confirm('Haluatko varmasti tyhjentää kaikki asetukset ja kamerat?')) return;
    localStorage.clear();
    vmixIp = '127.0.0.1';
    timerDuration = 180;
    mainTimer = timerDuration;
    cameras = [];
    categories = [];
    programInput = null;
    previewInput = null;
    lastProgramInput = null;
    updateTimerDisplay();
    renderCameras();
    updateCategoryListUI();
    populateCategorySelect();
    updateStatus('Kaikki asetukset tyhjennetty', true);
  }

  // --- Init ---
  function init() {
    loadFromStorage();
    updateTimerDisplay();
    renderCameras();
    updateCategoryListUI();
    populateCategorySelect();
    // Poll vMix every 1s
    setInterval(pollVmix, 1000);
    // Timer tick every 1s
    setInterval(tickTimer, 1000);
  }

  init();
</script>
</body>
</html>
