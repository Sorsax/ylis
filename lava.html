<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YLISâ„¢ Lava</title>
<link rel="icon" href="./img/favicon.ico">

<style>
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  h1,h2,h3 {
    font-family: Arial, sans-serif;
  }
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #222;
    border-bottom: 1px solid #333;
    position: relative;
    z-index: 1001;
    height: 100px;
    flex-direction: column;
  }
  
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    flex: 1;
  }
  
  .header-tabs {
    display: flex;
    gap: 10px;
    margin-top: 8px;
  }
  
  .tab {
    background: none;
    color: #888;
    border: none;
    padding: 0;
    cursor: pointer;
    font-size: 14px;
    text-decoration: underline;
    transition: color 0.3s ease;
  }
  
  .tab:hover {
    color: #ccc;
  }
  
  .tab.active {
    color: #fff;
  }
  header > div {
    flex: 1;
    display: flex;
    align-items: center;
  }
  .header-top > div:first-child {
    justify-content: flex-start;
    flex-direction: column;
    align-items: flex-start;
  }
  .header-top > div:nth-child(2) {
    justify-content: center;
  }
  .header-top > div:last-child {
    justify-content: flex-end;
    flex-direction: column;
    align-items: flex-end;
  }
  #currentTime {
    font-size: 36px;
    color: #fff;
    user-select: none;
    font-family: Arial, sans-serif;
  }
  #settingsToggle {
    background: none;
    color: #888;
    border: none;
    padding: 0;
    font-size: 12px;
    cursor: pointer;
    user-select: none;
    margin-left: 10px;
    text-decoration: underline;
  }
  #settingsToggle:hover {
    color: #ccc;
  }
  #settingsPanel {
    position: fixed;
    top: 0; right: 0;
    width: 380px;
    height: 100%;
    background: #222;
    border-left: 2px solid #333;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    padding: 0;
    overflow-y: auto;
    z-index: 2001;
    display: flex;
    flex-direction: column;
  }
  #settingsPanel.open {
    transform: translateX(0);
  }
  
  .settings-header {
    padding: 20px;
    background: #333;
    border-bottom: 2px solid #444;
    position: relative;
  }
  
  .settings-content {
    flex: 1;
    padding: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    height: calc(100vh - 80px);
  }
  
  .settings-section {
    padding: 20px;
    border-right: 1px solid #333;
    overflow-y: auto;
  }
  
  .settings-section:last-child {
    border-right: none;
  }
  
  .settings-section h3 {
    margin: 0 0 15px 0;
    color: #fff;
    font-size: 16px;
    border-bottom: 1px solid #444;
    padding-bottom: 8px;
  }
  
  #settingsPanel input, #settingsPanel select, #settingsPanel button {
    width: 100%;
    margin: 5px 0 10px 0;
    padding: 8px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
    font-size: 13px;
  }
  
  #settingsPanel button {
    background: #444;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  #settingsPanel button:hover {
    background: #555;
  }
  
  .btn-primary {
    background: #444 !important;
  }
  
  .btn-primary:hover {
    background: #555 !important;
  }
  
  .btn-danger {
    background: #a00 !important;
  }
  
  .btn-danger:hover {
    background: #c33 !important;
  }
  
  .btn-small {
    padding: 4px 8px;
    font-size: 12px;
    width: auto;
    margin: 0 0 0 8px;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    overflow: hidden;
    margin-right: 420px;
    transition: margin-right 0.3s;
    position: relative;
  }
  
  .tab-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: calc(100% - 240px);
    display: none;
  }
  
  .tab-content.active {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  
  #sheetsTab.tab-content.active {
    justify-content: stretch;
    align-items: stretch;
    padding: 0;
  }
  
  #tallyTab.tab-content.active {
    justify-content: stretch;
    align-items: stretch;
    padding: 0;
  }
  
  .custom-tab-content.tab-content.active {
    justify-content: stretch;
    align-items: stretch;
    padding: 0;
  }
  
  #googleSheetsFrame {
    width: 100%;
    height: 100%;
    min-height: 400px;
    border: none;
    background: #fff;
    flex: 1;
    overflow: hidden;
  }
  
  #timersContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 100;
    pointer-events: none;
    width: 100%;
    text-align: center;
    position: static;
    margin-top: -110px;
    transform: translateX(-110px);
  }

  #mainTimer {
    font-size: 160px;
    color: #FFC032;
    font-weight: bold;
    user-select: none;
    transition: color 0.5s;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    font-family: Arial, sans-serif;
  }
  
  #programTimer {
    font-size: 42px;
    color: #fff;
    user-select: none;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    font-family: Arial, sans-serif;
    margin-top: -10px;
  }
  #cameraContainer {
    background-color: #111;
    border-top: 1px solid #333;
    padding: 15px 20px;
    overflow-x: auto;
    overflow-y: auto;
    white-space: nowrap;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 200;
    min-height: 180px;
    max-height: 60vh;
  }
  .category {
    margin-bottom: 10px;
  }
  .category h2 {
    font-size: 18px;
    margin-bottom: 5px;
    user-select: none;
  }
  .camera-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    overflow-x: visible;
  }
  .camera {
    background: #383434;
    border-radius: 12px;
    padding: 20px;
    min-width: 400px;
    min-height: 180px;
    text-align: center;
    white-space: normal;
    flex-shrink: 0;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .camera::before {
    content: '';
    display: block;
    position: absolute;
    top: 0;
    right: 0;
    width: 32px;
    height: 100%;
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
    background: #444;
    box-sizing: border-box;
  }

  .camera.program::before {
    background: #fb0a0b !important;
  }
  .camera.preview:not(.program)::before {
    background: #20a423 !important;
  }
  .camera.none::before {
    background: #444 !important;
  }

  .camera .focus-indicator {
    position: absolute;
    top: 15px;
    left: 15px;
    background: #ff1900;
    color: white;
    font-weight: bold;
    font-size: 16px;
    padding: 8px 16px;
    border-radius: 18px;
    display: none;
    z-index: 10;
    animation: focusBlink 1s infinite;
  }

  .camera .tally-indicator {
    position: absolute;
    top: 15px;
    left: 15px;
    color: white;
    font-weight: bold;
    font-size: 16px;
    padding: 8px 16px;
    border-radius: 18px;
    display: none;
    z-index: 10;
  }

  .camera.program .tally-indicator {
    background: #fb0a0b;
    display: block;
  }

  .camera.preview:not(.program) .tally-indicator {
    background: #20a423;
    display: block;
  }

  .camera.program .tally-indicator {
    background: #fb0a0b !important;
    display: block !important;
  }

  .camera .focus-indicator:not(.hidden) ~ .tally-indicator {
    top: 60px;
  }

  @keyframes focusBlink {
    0%, 50% {
      opacity: 1;
    }
    50.01%, 100% {
      opacity: 0.3;
    }
  }

  .camera.preview .focus-indicator {
    display: block;
  }

  .camera .focus-indicator.hidden {
    display: none !important;
  }

  .camera .tally-indicator.hidden {
    display: none !important;
  }

  .camera .edit-btn, .camera .move-up-btn, .camera .move-down-btn {
    width: 48%;
    margin: 6px 1% 0 1%;
    background: #a00;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
    display: inline-block;
  }
  .camera .edit-btn:hover, .camera .move-up-btn:hover, .camera .move-down-btn:hover {
    background: #f33;
  }
  .camera .move-up-btn, .camera .move-down-btn {
    width: 22%;
    font-size: 16px;
    margin: 6px 2% 0 2%;
    background: #444;
    color: #fff;
  }
  .camera .move-up-btn:disabled, .camera .move-down-btn:disabled {
    opacity: 0.5;
    cursor: default;
    background: #222;
  }
footer {
    background: #222;
    padding: 5px 15px;
    font-size: 14px;
    color: #ccc;
    text-align: left;
    border-top: 1px solid #333;
    user-select: none;
    position: relative;
    z-index: 1001;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  footer.ok { color: #0f0; }
  footer.fail { color: #f00; }
  label {
    user-select: none;
  }
  .blinking {
    color: red;
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%, 50% {
      opacity: 1;
    }
    50.01%, 100% {
      opacity: 0;
    }
  }
  .category-select {
    width: 100%;
    margin-top: 5px;
    margin-bottom: 15px;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 6px;
  }
  .item-list {
    max-height: 120px;
    overflow-y: auto;
    margin-bottom: 15px;
    border: 1px solid #555;
    border-radius: 4px;
    background: #222;
    padding: 8px;
  }
  .item-list-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    padding: 6px;
    background: #333;
    border-radius: 4px;
    font-size: 13px;
  }
  .item-list-entry:last-child {
    margin-bottom: 0;
  }
  .item-list-entry .item-info {
    flex: 1;
  }
  .item-list-entry .item-name {
    font-weight: bold;
    margin-bottom: 2px;
  }
  .item-list-entry .item-details {
    font-size: 11px;
    color: #ccc;
    word-break: break-all;
  }

  .camera.dragging {
    opacity: 0.5;
    border: 2px dashed #fff;
  }
  .camera.drag-over {
    outline: 2px solid #FFC032;
  }

  .tab.dragging {
    opacity: 0.5;
    color: #fff !important;
    transform: rotate(2deg);
  }
  .tab.drag-over {
    color: #FFC032 !important;
    background: rgba(255, 192, 50, 0.1);
    padding: 2px 4px;
    border-radius: 2px;
  }
  
  .tab[draggable="true"] {
    position: relative;
    padding-right: 12px;
  }
  
  .tab[draggable="true"]:hover {
    color: #ccc;
  }
  
  .tab[draggable="true"]::after {
    content: 'â‹®â‹®';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 8px;
    color: #666;
    line-height: 4px;
  }

  #ontimeFramePanel {
    position: fixed;
    top: -20px;
    right: -10px;
    width: 420px;
    height: calc(100vh + 24px);
    background: #181818;
    border-left: 2px solid #333;
    z-index: 900;
    display: flex;
    flex-direction: column;
    pointer-events: none;
  }
  #ontimeFramePanel iframe {
    width: 100%;
    height: 100%;
    border: none;
    flex: 1 1 auto;
    background: #222;
    pointer-events: none;
  }
  
  #cameraHistoryPanel {
    position: fixed;
    top: 100px;
    right: 410px;
    width: 220px;
    bottom: 150px;
    background: #1a1a1a;
    border-left: 2px solid #333;
    z-index: 900;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #cameraHistoryPanel h3 {
    margin: 0;
    padding: 15px;
    background: #222;
    border-bottom: 1px solid #333;
    font-size: 16px;
    text-align: center;
  }
  #cameraHistoryList {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .history-entry {
    background: #333;
    margin-bottom: 8px;
    padding: 10px;
    border-radius: 4px;
    font-size: 12px;
  }
  .history-entry-time {
    color: #999;
    font-size: 10px;
    margin-bottom: 2px;
  }
  .history-entry-camera {
    font-weight: bold;
    margin-bottom: 2px;
  }
  .history-entry-action {
    color: #ccc;
    font-size: 11px;
  }
  main {
    margin-right: 420px;
    transition: margin-right 0.3s;
  }
  @media (max-width: 900px) {
    #ontimeFramePanel {
      width: 100vw;
      left: 0;
      right: 0;
    }
    #cameraHistoryPanel {
      display: none;
    }
    main {
      margin-right: 0;
    }
  }
</style>
</head>
<body>
<header>
  <div class="header-top">
    <div>
      <div class="header-tabs">
      </div>
    </div>
    <div></div>
    <div>
      <div id="currentTime">00:00:00.000</div>
    </div>
  </div>
</header>

<div id="cameraHistoryPanel">
  <h3>Kamerahistoria</h3>
  <div id="cameraHistoryList"></div>
</div>

<div id="ontimeFramePanel">
  <iframe id="ontimeFrame"></iframe>
</div>

<main>
  <div id="timersTab" class="tab-content">
    <div id="timersContainer">
      <div id="mainTimer">03:00</div>
      <div id="programTimer">00:00.000</div>
    </div>
  </div>
  
  <div id="sheetsTab" class="tab-content active">
    <iframe id="googleSheetsFrame" 
            src="">
    </iframe>
  </div>
  
  <div id="kuvakoContainer" class="tab-content">
    <img src="img/kuvakoot.png" alt="Kuvakoot" style="position: absolute; top: 0; left: 0; display: block;" />
  </div>
  
  <div id="tallyTab" class="tab-content">
    <iframe id="tallyFrame" 
            src=""
            style="width: 100%; height: 100%; border: none; background: #fff; flex: 1; overflow: hidden; margin-top: 0px; margin-left: -120px;">
    </iframe>
  </div>
  
  <div id="cameraContainer"></div>
</main>

<footer id="status" class="fail">
  <span>vMix: Ei yhteyttÃ¤</span>
  <span id="settingsToggle" onclick="toggleSettings()">Asetukset</span>
</footer>

<div id="settingsPanel">
  <div class="settings-header">
    <span id="settingsClose"
      style="position:absolute;top:12px;right:18px;z-index:1101;cursor:pointer;display:inline-block;width:32px;height:32px;line-height:32px;text-align:center;font-size:22px;color:#fff;border-radius:50%;background:rgba(0,0,0,0.15);"
      onclick="toggleSettings()" title="Sulje asetukset"
      onmouseover="this.style.background='rgba(255,255,255,0.15)';"
      onmouseout="this.style.background='rgba(0,0,0,0.15)';"
    >&times;</span>
    <h2 style="margin: 0; color: #fff;">Asetukset</h2>
  </div>
  
  <div class="settings-content">
    <div class="settings-section">
      <h3>Yhteydet</h3>
      <label>vMix IP:<br><input type="text" id="vmixIp" /></label>
      <label>vMix Port:<br><input type="number" id="vmixPort" min="1" max="65535" value="8088" /></label>
      <label>Ontime IP:<br><input type="text" id="ontimeIp" placeholder="127.0.0.1" /></label>
      <label>Ontime Port:<br><input type="number" id="ontimePort" min="1" max="65535" value="4001" /></label>
      <label>Sheets-URL:<br><input type="text" id="googleSheetsUrl" placeholder="" /></label>
      
      <h3>Asetuspohjat</h3>
      <div class="item-list" id="presetsList"></div>
      <label>Uusi pohja:<br><input type="text" id="newPresetName" placeholder="Anna pohjan nimi" /></label>
      <button onclick="savePreset()" class="btn-primary">Tallenna pohja</button>

      <h3>Toiminnot</h3>
      <label style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="editModeToggle" onchange="toggleEditMode()" style="width: auto; margin: 0 8px 0 0;" />
        Muokkaustila
      </label>
      <label style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="focusIndicatorToggle" onchange="toggleFocusIndicator()" style="width: auto; margin: 0 8px 0 0;" />
        Fokkaritila
      </label>
      <label style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="tallyIndicatorToggle" onchange="toggleTallyIndicator()" style="width: auto; margin: 0 8px 0 0;" />
        Zoomaajatila
      </label>
      <label style="display: flex; align-items: center; margin-bottom: 15px;">
        <input type="checkbox" id="ontimeFrameToggle" onchange="toggleOntimeFrame()" style="width: auto; margin: 0 8px 0 0;" />
        NÃ¤ytÃ¤ Ontime
      </label>
      <button onclick="applySettings()" class="btn-primary">Tallenna asetukset</button>
      <button onclick="resetAll()" class="btn-danger">TyhjennÃ¤ kaikki asetukset</button>
    </div>
    
    <div class="settings-section">
      <h3>Kamerat</h3>
      <label>Nimi:<br><input type="text" id="camName" /></label>
      <label>vMix Input:<br>
        <select id="camInput">
          <option value="">(Valitse input)</option>
        </select>
      </label>
      <label>Kategoria:<br>
        <select id="camCategorySelect">
          <option value="">(Ei kategoriaa)</option>
        </select>
      </label>
      <button onclick="addCamera()" class="btn-primary">LisÃ¤Ã¤ kamera</button>

      <h3>Kategoriat</h3>
      <div class="item-list" id="categoryList"></div>
      <label>Uusi kategoria:<br><input type="text" id="newCategoryName" /></label>
      <button onclick="addCategory()" class="btn-primary">LisÃ¤Ã¤ kategoria</button>

      <h3>Omat vÃ¤lilehdet</h3>
      <div class="item-list" id="customTabsList"></div>
      <label>VÃ¤lilehden nimi:<br><input type="text" id="customTabName" placeholder="" /></label>
      <label>URL:<br><input type="text" id="customTabUrl" placeholder="" /></label>
      <button onclick="addCustomTab()" class="btn-primary">LisÃ¤Ã¤ vÃ¤lilehti</button>
    </div>
  </div>
</div>

<script>
  let vmixIp = localStorage.getItem('stage_vmixIp') || '127.0.0.1';
  let vmixPort = localStorage.getItem('stage_vmixPort') || '8088';
let ontimeIp = localStorage.getItem('stage_ontimeIp') || '127.0.0.1';
  let ontimePort = localStorage.getItem('stage_ontimePort') || '4001';
  let googleSheetsUrl = localStorage.getItem('stage_googleSheetsUrl') || '';
  let timerDuration = 180;
  let warnThreshold = 20;
  let cameras = [];
  let categories = [];
  let programInput = null;
  let previewInput = null;
  let mainTimer = timerDuration;
  let lastProgramInput = null;
  let vmixInputNames = {};
  let editMode = false;
  let currentTab = 'sheets';
  let customTabs = [];
  let showFocusIndicator = true;
  let showTallyIndicator = true;
  let showOntimeFrame = true;
  let settingsPresets = [];

  function savePreset() {
    const presetName = document.getElementById('newPresetName').value.trim();
    if (!presetName) {
      alert('Anna asetuspohjan nimi');
      return;
    }
    
    if (settingsPresets.find(p => p.name === presetName)) {
      if (!confirm(`Pohja '${presetName}' on jo olemassa. Korvataanko se?`)) {
        return;
      }
    }

    const preset = {
      name: presetName,
      timestamp: Date.now(),
      settings: {
        vmixIp: vmixIp,
        vmixPort: vmixPort,
        ontimeIp: ontimeIp,
        ontimePort: ontimePort,
        googleSheetsUrl: googleSheetsUrl,
        timerDuration: timerDuration,
        warnThreshold: warnThreshold,
        cameras: JSON.parse(JSON.stringify(cameras)),
        categories: JSON.parse(JSON.stringify(categories)),
        customTabs: JSON.parse(JSON.stringify(customTabs)),
        showFocusIndicator: showFocusIndicator,
        showTallyIndicator: showTallyIndicator,
        showOntimeFrame: showOntimeFrame
      }
    };

    settingsPresets = settingsPresets.filter(p => p.name !== presetName);
    settingsPresets.push(preset);
    
    localStorage.setItem('stage_settingsPresets', JSON.stringify(settingsPresets));
    updatePresetsList();
    document.getElementById('newPresetName').value = '';
    alert(`Asetuspohja '${presetName}' tallennettu`);
  }

  function loadPreset(presetName) {
    const preset = settingsPresets.find(p => p.name === presetName);
    if (!preset) {
      alert('Asetuspohjaa ei lÃ¶ytynyt');
      return;
    }

    if (!confirm(`Ladataanko asetuspohja '${presetName}'? TÃ¤mÃ¤ korvaa nykyiset asetukset.`)) {
      return;
    }

    const settings = preset.settings;
    vmixIp = settings.vmixIp;
    vmixPort = settings.vmixPort;
    ontimeIp = settings.ontimeIp;
    ontimePort = settings.ontimePort;
    googleSheetsUrl = settings.googleSheetsUrl;
    timerDuration = settings.timerDuration;
    warnThreshold = settings.warnThreshold;
    cameras = JSON.parse(JSON.stringify(settings.cameras));
    categories = JSON.parse(JSON.stringify(settings.categories));
    customTabs = JSON.parse(JSON.stringify(settings.customTabs));
    showFocusIndicator = settings.showFocusIndicator;
    showTallyIndicator = settings.showTallyIndicator;
    showOntimeFrame = settings.showOntimeFrame !== undefined ? settings.showOntimeFrame : true;

    // Initialize camera timers for loaded cameras
    cameraTimers = {};
    for (const cam of cameras) {
      cameraTimers[cam.input] = {totalTimeInProgram: 0, currentTimeInProgram: 0, isInProgram: false};
    }

    saveToStorage();
    loadSettingsToUI();
    renderCameras();
    renderTabs();
    updateCategoryListUI();
    populateCategorySelect();
    updateGoogleSheetsFrame();
    updateOntimeFrameSrc();
    updateTallyFrame();
    updateCustomTabsList();
    
    alert(`Asetuspohja '${presetName}' ladattu`);
  }

  function removePreset(presetName) {
    if (!confirm(`Poistetaanko asetuspohja '${presetName}'?`)) return;
    
    settingsPresets = settingsPresets.filter(p => p.name !== presetName);
    localStorage.setItem('stage_settingsPresets', JSON.stringify(settingsPresets));
    updatePresetsList();
  }

  function updatePresetsList() {
    const listDiv = document.getElementById('presetsList');
    if (!listDiv) return;
    
    listDiv.innerHTML = '';
    
    for (const preset of settingsPresets) {
      const row = document.createElement('div');
      row.className = 'item-list-entry';
      
      const info = document.createElement('div');
      info.className = 'item-info';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'item-name';
      nameDiv.textContent = preset.name;
      
      const dateDiv = document.createElement('div');
      dateDiv.className = 'item-details';
      const date = new Date(preset.timestamp);
      dateDiv.textContent = date.toLocaleString('fi-FI');
      
      info.appendChild(nameDiv);
      info.appendChild(dateDiv);
      
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.gap = '4px';
      
      const loadBtn = document.createElement('button');
      loadBtn.textContent = 'Lataa';
      loadBtn.title = `Lataa asetuspohja '${preset.name}'`;
      loadBtn.className = 'btn-small btn-primary';
      loadBtn.onclick = () => loadPreset(preset.name);
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'X';
      removeBtn.title = `Poista asetuspohja '${preset.name}'`;
      removeBtn.className = 'btn-small btn-danger';
      removeBtn.onclick = () => removePreset(preset.name);
      
      buttonContainer.appendChild(loadBtn);
      buttonContainer.appendChild(removeBtn);
      
      row.appendChild(info);
      row.appendChild(buttonContainer);
      listDiv.appendChild(row);
    }
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    let tabContent;
    if (tabName === 'kuvako') {
      tabContent = document.getElementById('kuvakoContainer');
    } else {
      tabContent = document.getElementById(tabName + 'Tab');
    }
    
    if (tabContent) {
      tabContent.classList.add('active');
    }
    
    event.target.classList.add('active');
    
    currentTab = tabName;
  }

  function generateTabId() {
    return 'customTab_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
  }

  function addCustomTab() {
    const name = document.getElementById('customTabName').value.trim();
    const url = document.getElementById('customTabUrl').value.trim();
    
    if (!name || !url) {
      alert('Anna vÃ¤lilehden nimi ja URL');
      return;
    }
    
    const tabId = generateTabId();
    const newTab = {
      id: tabId,
      name: name,
      url: url
    };
    
    customTabs.push(newTab);
    saveToStorage();
    renderTabs();
    document.getElementById('customTabName').value = '';
    document.getElementById('customTabUrl').value = '';
    updateCustomTabsList();
  }

  function removeCustomTab(tabId) {
    const tab = customTabs.find(t => t.id === tabId);
    if (!tab) return;
    
    if (!confirm(`Poistetaanko vÃ¤lilehti '${tab.name}'?`)) return;
    
    if (currentTab === tabId) {
      switchToTab('sheets');
    }
    
    customTabs = customTabs.filter(t => t.id !== tabId);
    
    const tabContent = document.getElementById(tabId + 'Tab');
    if (tabContent) {
      tabContent.remove();
    }
    
    saveToStorage();
    renderTabs();
    updateCustomTabsList();
  }

  function switchToTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    let tabContent;
    if (tabName === 'kuvako') {
      tabContent = document.getElementById('kuvakoContainer');
    } else {
      tabContent = document.getElementById(tabName + 'Tab');
    }
    
    if (tabContent) {
      tabContent.classList.add('active');
    }
    
    currentTab = tabName;
    
    renderTabs();
  }

  function renderTabs() {
    const tabsContainer = document.querySelector('.header-tabs');
    if (!tabsContainer) return;
    
    tabsContainer.innerHTML = '';
    
    const kuvakoTab = document.createElement('button');
    kuvakoTab.className = currentTab === 'kuvako' ? 'tab active' : 'tab';
    kuvakoTab.textContent = 'Kuvakoot';
    kuvakoTab.onclick = () => switchToTab('kuvako');
    tabsContainer.appendChild(kuvakoTab);
    
    const tallyTab = document.createElement('button');
    tallyTab.className = currentTab === 'tally' ? 'tab active' : 'tab';
    tallyTab.textContent = 'Tally';
    tallyTab.onclick = () => switchToTab('tally');
    tabsContainer.appendChild(tallyTab);
    
    const sheetsTab = document.createElement('button');
    sheetsTab.className = currentTab === 'sheets' ? 'tab active' : 'tab';
    sheetsTab.textContent = 'Minari';
    sheetsTab.onclick = () => switchToTab('sheets');
    tabsContainer.appendChild(sheetsTab);
    
    // Check if there are any existing iframes or other content that should have tabs
    const allTabContents = document.querySelectorAll('.tab-content');
    allTabContents.forEach(tabContent => {
      const tabId = tabContent.id.replace('Tab', '').replace('Container', '');
      if (tabId !== 'sheets' && tabId !== 'timers' && tabId !== 'kuvako' && tabId !== 'tally' && !customTabs.find(t => t.id === tabId)) {
        const tabButton = document.createElement('button');
        tabButton.className = currentTab === tabId ? 'tab active' : 'tab';
        tabButton.textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1);
        tabButton.onclick = () => switchToTab(tabId);
        tabsContainer.appendChild(tabButton);
      }
    });
    
    for (let i = 0; i < customTabs.length; i++) {
      const tab = customTabs[i];
      const tabButton = document.createElement('button');
      tabButton.className = currentTab === tab.id ? 'tab active' : 'tab';
      tabButton.textContent = tab.name;
      tabButton.onclick = () => switchToTab(tab.id);
      tabButton.dataset.tabId = tab.id;
      tabButton.dataset.tabIndex = i.toString();
      
      if (editMode) {
        tabButton.setAttribute('draggable', 'true');
        tabButton.style.cursor = 'move';
        
        tabButton.ondragstart = (e) => {
          e.dataTransfer.setData('text/plain', tab.id);
          tabButton.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        };
        
        tabButton.ondragend = (e) => {
          tabButton.classList.remove('dragging');
          document.querySelectorAll('.tab.drag-over').forEach(el => el.classList.remove('drag-over'));
        };
        
        tabButton.ondragover = (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (!tabButton.classList.contains('dragging')) {
            tabButton.classList.add('drag-over');
          }
        };
        
        tabButton.ondragenter = (e) => {
          e.preventDefault();
          if (!tabButton.classList.contains('dragging')) {
            tabButton.classList.add('drag-over');
          }
        };
        
        tabButton.ondragleave = (e) => {
          const rect = tabButton.getBoundingClientRect();
          if (e.clientX < rect.left || e.clientX > rect.right || 
              e.clientY < rect.top || e.clientY > rect.bottom) {
            tabButton.classList.remove('drag-over');
          }
        };
        
        tabButton.ondrop = (e) => {
          e.preventDefault();
          tabButton.classList.remove('drag-over');
          const draggedTabId = e.dataTransfer.getData('text/plain');
          
          if (draggedTabId === tab.id) return;
          
          const fromIdx = customTabs.findIndex(t => t.id === draggedTabId);
          const toIdx = customTabs.findIndex(t => t.id === tab.id);
          
          if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
            const movedTab = customTabs.splice(fromIdx, 1)[0];
            customTabs.splice(toIdx, 0, movedTab);
            saveToStorage();
            renderTabs();
          }
        };
      } else {
        tabButton.removeAttribute('draggable');
        tabButton.style.cursor = 'pointer';
        tabButton.ondragstart = null;
        tabButton.ondragend = null;
        tabButton.ondragover = null;
        tabButton.ondragenter = null;
        tabButton.ondragleave = null;
        tabButton.ondrop = null;
      }
      
      tabsContainer.appendChild(tabButton);
      
      createCustomTabContent(tab);
    }
  }

  function createCustomTabContent(tab) {
    if (document.getElementById(tab.id + 'Tab')) return;
    
    const tabContent = document.createElement('div');
    tabContent.id = tab.id + 'Tab';
    tabContent.className = 'tab-content custom-tab-content';
    
    const iframe = document.createElement('iframe');
    iframe.src = tab.url;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.background = '#fff';
    iframe.style.flex = '1';
    iframe.style.overflow = 'hidden';
    
    tabContent.appendChild(iframe);
    
    const main = document.querySelector('main');
    if (main) {
      const cameraContainer = document.getElementById('cameraContainer');
      if (cameraContainer) {
        main.insertBefore(tabContent, cameraContainer);
      } else {
        main.appendChild(tabContent);
      }
    }
  }

  function updateCustomTabsList() {
    const listDiv = document.getElementById('customTabsList');
    if (!listDiv) return;
    
    listDiv.innerHTML = '';
    
    for (const tab of customTabs) {
      const row = document.createElement('div');
      row.className = 'item-list-entry';
      
      const info = document.createElement('div');
      info.className = 'item-info';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'item-name';
      nameDiv.textContent = tab.name;
      
      const urlDiv = document.createElement('div');
      urlDiv.className = 'item-details';
      urlDiv.textContent = tab.url;
      
      info.appendChild(nameDiv);
      info.appendChild(urlDiv);
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'X';
      removeBtn.title = `Poista vÃ¤lilehti '${tab.name}'`;
      removeBtn.className = 'btn-small btn-danger';
      removeBtn.onclick = () => removeCustomTab(tab.id);
      
      row.appendChild(info);
      row.appendChild(removeBtn);
      listDiv.appendChild(row);
    }
  }

  let programStartTime = null;
  let currentProgramInput = null;

  let cameraTimers = {};

  let cameraHistory = [];
  let maxHistoryEntries = 50;

  function formatTime(s) {
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const sec = (s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
  }
  
  function formatTimeWithMilliseconds(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
    const milliseconds = (ms % 1000).toString().padStart(3, '0');
    return `${minutes}:${seconds}.${milliseconds}`;
  }

  function saveToStorage() {
    localStorage.setItem('stage_vmixIp', vmixIp);
    localStorage.setItem('stage_vmixPort', vmixPort);
    localStorage.setItem('stage_ontimeIp', ontimeIp);
    localStorage.setItem('stage_ontimePort', ontimePort);
    localStorage.setItem('stage_googleSheetsUrl', googleSheetsUrl);
    localStorage.setItem('stage_timerDuration', timerDuration);
    localStorage.setItem('stage_warnThreshold', warnThreshold);
    localStorage.setItem('stage_cameras', JSON.stringify(cameras));
    localStorage.setItem('stage_categories', JSON.stringify(categories));
    localStorage.setItem('stage_customTabs', JSON.stringify(customTabs));
    localStorage.setItem('stage_showFocusIndicator', showFocusIndicator);
    localStorage.setItem('stage_showTallyIndicator', showTallyIndicator);
    localStorage.setItem('stage_showOntimeFrame', showOntimeFrame);
  }
  function loadFromStorage() {
    vmixIp = localStorage.getItem('stage_vmixIp') || '127.0.0.1';
    vmixPort = localStorage.getItem('stage_vmixPort') || '8088';
    ontimeIp = localStorage.getItem('stage_ontimeIp') || 'localhost';
    ontimePort = localStorage.getItem('stage_ontimePort') || '4001';
    googleSheetsUrl = localStorage.getItem('stage_googleSheetsUrl') || '';
    timerDuration = parseInt(localStorage.getItem('stage_timerDuration')) || 180;
    warnThreshold = parseInt(localStorage.getItem('stage_warnThreshold')) || 20;
    cameras = JSON.parse(localStorage.getItem('stage_cameras') || '[]');
    categories = JSON.parse(localStorage.getItem('stage_categories') || '[]');
    customTabs = JSON.parse(localStorage.getItem('stage_customTabs') || '[]');
    showFocusIndicator = localStorage.getItem('stage_showFocusIndicator') !== 'false';
    showTallyIndicator = localStorage.getItem('stage_showTallyIndicator') !== 'false';
    showOntimeFrame = localStorage.getItem('stage_showOntimeFrame') !== 'false';
    settingsPresets = JSON.parse(localStorage.getItem('stage_settingsPresets') || '[]');
  }

  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
      loadSettingsToUI();
    }
  }
  function loadSettingsToUI() {
    document.getElementById('vmixIp').value = vmixIp;
    document.getElementById('vmixPort').value = vmixPort;
    document.getElementById('ontimeIp').value = ontimeIp;
    document.getElementById('ontimePort').value = ontimePort;
    document.getElementById('googleSheetsUrl').value = googleSheetsUrl;
    document.getElementById('editModeToggle').checked = editMode;
    document.getElementById('focusIndicatorToggle').checked = showFocusIndicator;
    document.getElementById('tallyIndicatorToggle').checked = showTallyIndicator;
    document.getElementById('ontimeFrameToggle').checked = showOntimeFrame;
    populateCategorySelect();
    populateVmixInputSelect();
    document.getElementById('camName').value = '';
    document.getElementById('camInput').value = '';
    document.getElementById('camCategorySelect').value = '';
    updateCategoryListUI();
    document.getElementById('customTabName').value = '';
    document.getElementById('customTabUrl').value = '';
    updateCustomTabsList();
    document.getElementById('newPresetName').value = '';
    updatePresetsList();
  }
  function applySettings() {
    vmixIp = document.getElementById('vmixIp').value.trim() || '127.0.0.1';
    vmixPort = document.getElementById('vmixPort').value.trim() || '8088';
    ontimeIp = document.getElementById('ontimeIp').value.trim() || 'localhost';
    ontimePort = document.getElementById('ontimePort').value.trim() || '4001';
    googleSheetsUrl = document.getElementById('googleSheetsUrl').value.trim() || '';
    localStorage.setItem('stage_ontimeIp', ontimeIp);
    localStorage.setItem('stage_ontimePort', ontimePort);
    localStorage.setItem('stage_vmixPort', vmixPort);
    saveToStorage();
    updateOntimeFrameSrc();
    updateGoogleSheetsFrame();
    updateTallyFrame();
    alert('Asetukset tallennettu');
  }

  function toggleEditMode() {
    editMode = document.getElementById('editModeToggle').checked;
    renderCameras();
    renderTabs();
  }

  function toggleFocusIndicator() {
    showFocusIndicator = document.getElementById('focusIndicatorToggle').checked;
    saveToStorage();
    updateFocusIndicatorVisibility();
  }

  function toggleTallyIndicator() {
    showTallyIndicator = document.getElementById('tallyIndicatorToggle').checked;
    saveToStorage();
    updateTallyIndicatorVisibility();
  }

  function toggleOntimeFrame() {
    showOntimeFrame = document.getElementById('ontimeFrameToggle').checked;
    saveToStorage();
    updateOntimeFrameVisibility();
  }

  function updateFocusIndicatorVisibility() {
    const indicators = document.querySelectorAll('.focus-indicator');
    indicators.forEach(indicator => {
      if (showFocusIndicator) {
        indicator.style.display = '';
        indicator.style.visibility = '';
        indicator.classList.remove('hidden');
        // Restore the blinking animation
        indicator.style.animation = '';
      } else {
        indicator.style.display = 'none';
        indicator.style.visibility = 'hidden';
        indicator.classList.add('hidden');
        // Also remove any blinking animation
        indicator.style.animation = 'none';
      }
    });
  }

  function updateTallyIndicatorVisibility() {
    const indicators = document.querySelectorAll('.tally-indicator');
    indicators.forEach(indicator => {
      if (showTallyIndicator) {
        indicator.style.display = '';
        indicator.style.visibility = '';
        indicator.classList.remove('hidden');
      } else {
        indicator.style.display = 'none';
        indicator.style.visibility = 'hidden';
        indicator.classList.add('hidden');
      }
    });
  }

  function updateOntimeFrameVisibility() {
    const ontimeFrame = document.getElementById('ontimeFramePanel');
    const historyPanel = document.getElementById('cameraHistoryPanel');
    const mainElement = document.querySelector('main');
    
    if (showOntimeFrame) {
      ontimeFrame.style.display = 'flex';
      historyPanel.style.right = '410px';
      mainElement.style.marginRight = '420px';
    } else {
      ontimeFrame.style.display = 'none';
      historyPanel.style.right = '10px';
      mainElement.style.marginRight = '0px';
    }
  }

  function moveCamera(fromIdx, toIdx) {
    if (toIdx < 0 || toIdx >= cameras.length) return;
    const cam = cameras.splice(fromIdx, 1)[0];
    cameras.splice(toIdx, 0, cam);
    saveToStorage();
    renderCameras();
  }

  function populateCategorySelect() {
    const select = document.getElementById('camCategorySelect');
    select.innerHTML = '<option value="">(Ei kategoriaa)</option>';
    for (const cat of categories) {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    }
  }
  
  function populateVmixInputSelect() {
    const select = document.getElementById('camInput');
    const currentValue = select.value; // Preserve current selection
    select.innerHTML = '<option value="">(Valitse input)</option>';
    
    const sortedInputs = Object.entries(vmixInputNames).sort((a, b) => {
      const numA = parseInt(a[0]);
      const numB = parseInt(b[0]);
      return numA - numB;
    });
    
    for (const [inputNumber, inputName] of sortedInputs) {
      const option = document.createElement('option');
      option.value = inputNumber;
      option.textContent = `${inputNumber}: ${inputName}`;
      select.appendChild(option);
    }
    
    // Restore the previously selected value if it still exists
    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
      select.value = currentValue;
    }
  }
  
  function addCategory() {
    const newCat = document.getElementById('newCategoryName').value.trim();
    if (!newCat) {
      alert('Anna kategorian nimi');
      return;
    }
    if (categories.includes(newCat)) {
      alert('Kategoria on jo olemassa');
      return;
    }
    categories.push(newCat);
    saveToStorage();
    populateCategorySelect();
    updateCategoryListUI();
    document.getElementById('newCategoryName').value = '';
  }
  function removeCategory(cat) {
    if (!confirm(`Poistetaanko kategoria '${cat}'? TÃ¤mÃ¤ poistaa myÃ¶s siihen kuuluvat kamerat.`)) return;
    categories = categories.filter(c => c !== cat);
    cameras = cameras.filter(cam => cam.category !== cat);
    saveToStorage();
    populateCategorySelect();
    updateCategoryListUI();
    renderCameras();
  }
  function updateCategoryListUI() {
    const div = document.getElementById('categoryList');
    div.innerHTML = '';
    for (const cat of categories) {
      const row = document.createElement('div');
      row.className = 'item-list-entry';
      
      const info = document.createElement('div');
      info.className = 'item-info';
      info.textContent = cat;
      
      const btn = document.createElement('button');
      btn.textContent = 'X';
      btn.title = `Poista kategoria '${cat}'`;
      btn.className = 'btn-small btn-danger';
      btn.onclick = () => removeCategory(cat);
      
      row.appendChild(info);
      row.appendChild(btn);
      div.appendChild(row);
    }
  }

  function addCamera() {
    const name = document.getElementById('camName').value.trim();
    const input = document.getElementById('camInput').value.trim();
    const category = document.getElementById('camCategorySelect').value || null;
    if (!name || !input) {
      alert('Anna kameran nimi ja vMix Input');
      return;
    }
    if (cameras.find(c => c.input === input)) {
      alert('TÃ¤mÃ¤ vMix Input on jo lisÃ¤tty kameraksi.');
      return;
    }
    cameras.push({name, input, category});
    cameraTimers[input] = {totalTimeInProgram: 0, currentTimeInProgram: 0, isInProgram: false};
    saveToStorage();
    renderCameras();
    adjustAfterCameraChange();
    document.getElementById('camName').value = '';
    document.getElementById('camInput').value = '';
    document.getElementById('camCategorySelect').value = '';
  }
  function removeCamera(input) {
    if (!confirm(`Poistetaanko kamera, jonka vMix Input on '${input}'?`)) return;
    cameras = cameras.filter(c => c.input !== input);
    delete cameraTimers[input];
    saveToStorage();
    renderCameras();
    adjustAfterCameraChange();
  }

  function renderCameras() {
    const container = document.getElementById('cameraContainer');
    container.innerHTML = '';

    for (const cat of categories) {
      const cams = cameras.filter(c => c.category === cat);
      if (cams.length === 0) continue;

      const catDiv = document.createElement('div');
      catDiv.className = 'category';

      const title = document.createElement('h2');
      title.textContent = cat;
      catDiv.appendChild(title);

      const camRow = document.createElement('div');
      camRow.className = 'camera-row';

      for (const cam of cams) {
        camRow.appendChild(createCameraElement(cam));
      }

      catDiv.appendChild(camRow);
      container.appendChild(catDiv);
    }

    const uncategorized = cameras.filter(c => !c.category);
    if (uncategorized.length > 0) {
      const catDiv = document.createElement('div');
      catDiv.className = 'category';

      const title = document.createElement('h2');
      title.textContent = '(Ei kategoriaa)';
      catDiv.appendChild(title);

      const camRow = document.createElement('div');
      camRow.className = 'camera-row';

      for (const cam of uncategorized) {
        camRow.appendChild(createCameraElement(cam));
      }

      catDiv.appendChild(camRow);
      container.appendChild(catDiv);
    }
    
    setTimeout(() => {
      adjustCameraHistoryHeight();
      updateFocusIndicatorVisibility();
      updateTallyIndicatorVisibility();
      updateOntimeFrameVisibility();
    }, 200);
  }

  function adjustCameraHistoryHeight() {
    const cameraContainer = document.getElementById('cameraContainer');
    const historyPanel = document.getElementById('cameraHistoryPanel');
    
    if (cameraContainer && historyPanel) {
      const containerRect = cameraContainer.getBoundingClientRect();
      const containerHeight = containerRect.height;
      
      const adjustedHeight = containerHeight + 26;
      
      historyPanel.style.bottom = adjustedHeight + 'px';
    }
  }

  function adjustAfterCameraChange() {
    setTimeout(() => {
      adjustCameraHistoryHeight();
    }, 100);
  }

  function createCameraElement(cam) {

    const div = document.createElement('div');
    div.className = 'camera';
    div.dataset.input = cam.input;

    if (editMode) {
      div.setAttribute('draggable', 'true');
      div.ondragstart = (e) => {
        e.dataTransfer.setData('text/plain', cam.input);
        div.classList.add('dragging');
      };
      div.ondragend = () => {
        div.classList.remove('dragging');
        document.querySelectorAll('.camera.drag-over').forEach(el => el.classList.remove('drag-over'));
      };
      div.ondragover = (e) => {
        e.preventDefault();
        div.classList.add('drag-over');
      };
      div.ondragleave = () => {
        div.classList.remove('drag-over');
      };
      div.ondrop = (e) => {
        e.preventDefault();
        div.classList.remove('drag-over');
        const fromInput = e.dataTransfer.getData('text/plain');
        if (fromInput === cam.input) return;
        const fromIdx = cameras.findIndex(c => c.input === fromInput);
        const toIdx = cameras.findIndex(c => c.input === cam.input);
        if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
          const camObj = cameras.splice(fromIdx, 1)[0];
          cameras.splice(toIdx, 0, camObj);
          saveToStorage();
          renderCameras();
        }
      };
    } else {
      div.removeAttribute('draggable');
      div.ondragstart = null;
      div.ondragend = null;
      div.ondragover = null;
      div.ondragleave = null;
      div.ondrop = null;
    }

    const focusIndicator = document.createElement('div');
    focusIndicator.className = 'focus-indicator';
    focusIndicator.textContent = 'FOCUS';
    if (!showFocusIndicator) {
      focusIndicator.style.display = 'none';
      focusIndicator.classList.add('hidden');
    }
    div.appendChild(focusIndicator);

    const tallyIndicator = document.createElement('div');
    tallyIndicator.className = 'tally-indicator';
    if (!showTallyIndicator) {
      tallyIndicator.style.display = 'none';
      tallyIndicator.classList.add('hidden');
    }
    div.appendChild(tallyIndicator);

    // Create a main content area that avoids the side indicator
    const contentDiv = document.createElement('div');
    contentDiv.style.marginRight = '36px';
    contentDiv.style.display = 'flex';
    contentDiv.style.flexDirection = 'column';
    contentDiv.style.flex = '1';
    contentDiv.style.justifyContent = 'center';
    contentDiv.style.alignItems = 'center';
    contentDiv.style.fontSize = '24px';
    contentDiv.style.fontWeight = 'bold';
    contentDiv.style.color = '#fff';

    // Show the camera name in large text
    const largeNameDiv = document.createElement('div');
    largeNameDiv.textContent = cam.name;
    largeNameDiv.style.textAlign = 'center';
    largeNameDiv.style.marginBottom = '8px';
    contentDiv.appendChild(largeNameDiv);

    // Show the vMix input name (always create, update later if available)
    const inputNameDiv = document.createElement('div');
    inputNameDiv.className = 'input-name-div';
    inputNameDiv.style.fontSize = '16px';
    inputNameDiv.style.color = '#999';
    inputNameDiv.style.textAlign = 'center';
    inputNameDiv.innerHTML = vmixInputNames[cam.input] 
      ? `<span class="vmix-name">${vmixInputNames[cam.input]}</span>` 
      : `<span class="vmix-name">Input ${cam.input}</span>`;
    contentDiv.appendChild(inputNameDiv);

    div.appendChild(contentDiv);

    if (editMode) {
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.gap = '6px';
      buttonContainer.style.marginTop = '8px';
      buttonContainer.style.marginRight = '36px';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Poista';
      removeBtn.className = 'edit-btn';
      removeBtn.style.width = 'auto';
      removeBtn.style.flex = '1';
      removeBtn.onclick = () => removeCamera(cam.input);
      buttonContainer.appendChild(removeBtn);

      const idx = cameras.findIndex(c => c.input === cam.input);
      const upBtn = document.createElement('button');
      upBtn.textContent = 'â–²';
      upBtn.title = 'SiirrÃ¤ ylÃ¶s';
      upBtn.className = 'move-up-btn';
      upBtn.style.width = 'auto';
      upBtn.style.minWidth = '30px';
      upBtn.disabled = idx === 0;
      upBtn.onclick = () => moveCamera(idx, idx - 1);
      buttonContainer.appendChild(upBtn);

      const downBtn = document.createElement('button');
      downBtn.textContent = 'â–¼';
      downBtn.title = 'SiirrÃ¤ alas';
      downBtn.className = 'move-down-btn';
      downBtn.style.width = 'auto';
      downBtn.style.minWidth = '30px';
      downBtn.disabled = idx === cameras.length - 1;
      downBtn.onclick = () => moveCamera(idx, idx + 1);
      buttonContainer.appendChild(downBtn);

      div.appendChild(buttonContainer);
    }

    return div;
  }

  function updateCameraTimers() {
    // Timers removed for focus puller interface
  }

  function updateInputNamesInElements() {
    for (const cam of cameras) {
      const el = document.querySelector(`.camera[data-input="${cam.input}"]`);
      if (el) {
        let inputNameDiv = el.querySelector('.input-name-div');
        
        if (inputNameDiv) {
          if (vmixInputNames[cam.input]) {
            inputNameDiv.innerHTML = `<span class="vmix-name">${vmixInputNames[cam.input]}</span>`;
          } else {
            inputNameDiv.innerHTML = `<span class="vmix-name">Input ${cam.input}</span>`;
          }
        }
      }
    }
  }

  function updateCameraStatus() {
    for (const cam of cameras) {
      const el = document.querySelector(`.camera[data-input="${cam.input}"]`);
      if (!el) continue;
      el.classList.remove('program', 'preview', 'none');
      let camInputStr = String(cam.input).trim();
      let programStr = String(programInput).trim();
      let previewStr = String(previewInput).trim();
      if (window.DEBUG_VMIX_MATCH) {
        console.log(`Camera '${cam.name}' input='${camInputStr}' vs program='${programStr}' preview='${previewStr}'`);
      }
      let isProgram = camInputStr === programStr;
      let isPreview = camInputStr === previewStr;
      if (isProgram) {
        el.classList.add('program');
        const tallyIndicator = el.querySelector('.tally-indicator');
        if (tallyIndicator) {
          tallyIndicator.textContent = 'AJO';
        }
        if (!cameraTimers[cam.input]) cameraTimers[cam.input] = {totalTimeInProgram: 0, currentTimeInProgram: 0, isInProgram: false};
        if (!cameraTimers[cam.input].isInProgram) {
          cameraTimers[cam.input].isInProgram = true;
          cameraTimers[cam.input].currentTimeInProgram = 0;
        }
      } else if (cameraTimers[cam.input] && cameraTimers[cam.input].isInProgram) {
        cameraTimers[cam.input].isInProgram = false;
        cameraTimers[cam.input].currentTimeInProgram = 0;
      }
      if (isPreview) {
        el.classList.add('preview');
        const tallyIndicator = el.querySelector('.tally-indicator');
        if (tallyIndicator) {
          tallyIndicator.textContent = 'VALMIINA';
        }
      }
      if (!isProgram && !isPreview) {
        el.classList.add('none');
      }
    }
  }

  function updateTimerDisplay() {
    const timerDiv = document.getElementById('mainTimer');
    if (timerDiv) {
      timerDiv.textContent = formatTime(mainTimer);
      timerDiv.classList.remove('blinking');
      timerDiv.style.transition = 'none';

      if (mainTimer === 0) {
        timerDiv.classList.add('blinking');
        timerDiv.style.color = 'red';
      } else if (mainTimer <= warnThreshold) {
        timerDiv.style.color = 'red';
      } else {
        timerDiv.style.color = '#FFC032';
      }
    }
  }

  function updateClock() {
    const clockDiv = document.getElementById('currentTime');
    if (clockDiv) {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
      clockDiv.textContent = `${hours}:${minutes}:${seconds}.${milliseconds}`;
    }
  }

  function updateProgramTimer() {
    const programTimerDiv = document.getElementById('programTimer');
    if (programTimerDiv) {
      if (programStartTime && currentProgramInput) {
        const now = Date.now();
        const elapsed = now - programStartTime;
        programTimerDiv.textContent = formatTimeWithMilliseconds(elapsed);
        programTimerDiv.style.display = 'block';
      } else {
        programTimerDiv.textContent = '00:00.000';
        programTimerDiv.style.display = 'block';
      }
    }
  }

  function addToHistory(cameraInput, cameraName, action, type) {
    const now = new Date();
    const timeString = now.toLocaleTimeString('fi-FI', { 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit' 
    });
    
    const entry = {
      time: timeString,
      timestamp: now.getTime(),
      cameraInput: cameraInput,
      cameraName: cameraName || `Input ${cameraInput}`,
      action: action,
      type: type
    };
    
    cameraHistory.unshift(entry);
    
    if (cameraHistory.length > maxHistoryEntries) {
      cameraHistory = cameraHistory.slice(0, maxHistoryEntries);
    }
    
    updateHistoryDisplay();
  }
  
  function updateHistoryDisplay() {
    const historyList = document.getElementById('cameraHistoryList');
    if (!historyList) return;
    
    historyList.innerHTML = '';
    
    for (const entry of cameraHistory) {
      const entryDiv = document.createElement('div');
      entryDiv.className = 'history-entry';
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'history-entry-time';
      timeDiv.textContent = entry.time;
      
      const cameraDiv = document.createElement('div');
      cameraDiv.className = 'history-entry-camera';
      cameraDiv.textContent = entry.cameraName;
      
      const actionDiv = document.createElement('div');
      actionDiv.className = 'history-entry-action';
      actionDiv.textContent = entry.action;
      
      entryDiv.appendChild(timeDiv);
      entryDiv.appendChild(cameraDiv);
      entryDiv.appendChild(actionDiv);
      
      historyList.appendChild(entryDiv);
    }
  }
  
  function getCameraName(input) {
    const camera = cameras.find(cam => cam.input === input);
    if (camera) return camera.name;
    if (vmixInputNames[input]) return vmixInputNames[input];
    return `Input ${input}`;
  }

  function resetAll() {
    if (!confirm('Haluatko varmasti tyhjentÃ¤Ã¤ kaikki asetukset ja kamerat? (Asetuspohjat sÃ¤ilytetÃ¤Ã¤n)')) return;
    
    // Preserve presets before clearing localStorage
    const preservedPresets = localStorage.getItem('stage_settingsPresets');
    
    localStorage.clear();
    
    // Restore presets
    if (preservedPresets) {
      localStorage.setItem('stage_settingsPresets', preservedPresets);
    }
    
    vmixIp = '127.0.0.1';
    ontimeIp = 'localhost:4001';
    googleSheetsUrl = '';
    timerDuration = 180;
    warnThreshold = 20;
    mainTimer = timerDuration;
    cameras = [];
    categories = [];
    customTabs = [];
    settingsPresets = JSON.parse(preservedPresets || '[]');
    cameraTimers = {};
    programInput = null;
    previewInput = null;
    lastProgramInput = null;
    currentTab = 'sheets';
    showFocusIndicator = true;
    showTallyIndicator = true;
    showOntimeFrame = true;
    updateTimerDisplay();
    renderCameras();
    renderTabs();
    updateCategoryListUI();
    populateCategorySelect();
    updateGoogleSheetsFrame();
    updateCustomTabsList();
    updatePresetsList();
    updateStatus('Kaikki asetukset tyhjennetty (asetuspohjat sÃ¤ilytetty)', true);
  }

  function init() {
    loadFromStorage();
    updateTimerDisplay();
    renderCameras();
    renderTabs();
    updateCategoryListUI();
    populateCategorySelect();
    populateVmixInputSelect();
    for (const cam of cameras) {
      if (!cameraTimers[cam.input]) cameraTimers[cam.input] = {totalTimeInProgram: 0, currentTimeInProgram: 0, isInProgram: false};
    }
    setInterval(pollVmix, 100);
    setInterval(tickTimer, 1000);
    setInterval(updateCameraTimers, 1000);
    setInterval(updateClock, 10);
    setInterval(updateProgramTimer, 10);
    updateClock();
    updateProgramTimer();
    updateOntimeFrameVisibility();
    
    window.addEventListener('resize', adjustCameraHistoryHeight);
    
    setTimeout(() => {
      adjustCameraHistoryHeight();
    }, 500);
  }

  function pollVmix() {
    fetch(`http://${vmixIp}:${vmixPort}/api`)
      .then(res => {
        if (!res.ok) {
          updateStatus(`vMix: HTTP ${res.status}; ${res.statusText}`, false);
          throw new Error(`HTTP ${res.status}`);
        }
        return res.text();
      })
      .then(xmlStr => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlStr, "text/xml");
        const program = xml.querySelector("active").textContent;
        const preview = xml.querySelector("preview").textContent;

        if (programInput !== program) {
          if (program) {
            const inputName = vmixInputNames[program] || `Input ${program}`;
            addToHistory(program, getCameraName(program), inputName, 'program');
            programStartTime = Date.now();
            currentProgramInput = program;
          } else {
            programStartTime = null;
            currentProgramInput = null;
          }
          mainTimer = timerDuration;
          updateTimerDisplay();
        }
        
        programInput = program;
        previewInput = preview;

        vmixInputNames = {};
        xml.querySelectorAll("input").forEach(input => {
          const key = input.getAttribute("number");
          const name = input.getAttribute("title");
          vmixInputNames[key] = name;
        });

        updateCameraStatus();
        updateStatus("vMix: OK", true);
        updateInputNamesInElements();
        populateVmixInputSelect();
        setTimeout(() => updateCameraStatus(), 100);
      })
      .catch(err => {
        let msg = "vMix: Ei yhteyttÃ¤";
        if (err && err.message && err.message.startsWith("HTTP")) {
          msg = `vMix: ${err.message}`;
        } else if (err && err.message) {
          msg = `vMix: ${err.message}`;
        }
        updateStatus(msg, false);
      });
  }

  function tickTimer() {
    if (mainTimer > 0) {
      mainTimer--;
      updateTimerDisplay();
    }
  }

  function updateStatus(msg, ok) {
    const footer = document.getElementById('status');
    const statusSpan = footer.querySelector('span');
    if (statusSpan) {
      statusSpan.textContent = msg;
    }
    footer.className = ok ? 'ok' : 'fail';
  }

  function updateOntimeFrameSrc() {
    const frame = document.getElementById('ontimeFrame');
    if (frame) {
      frame.src = `http://${ontimeIp}:${ontimePort}/op`;
    }
  }

  function updateGoogleSheetsFrame() {
    const frame = document.getElementById('googleSheetsFrame');
    if (frame) {
      if (googleSheetsUrl && googleSheetsUrl.trim()) {
        frame.src = googleSheetsUrl.trim();
      } else {
        frame.src = '';
      }
    }
  }

  function updateTallyFrame() {
    const frame = document.getElementById('tallyFrame');
    if (frame) {
      frame.src = `http://${vmixIp}:${vmixPort}/tally`;
    }
  }

  init();
  window.addEventListener('DOMContentLoaded', () => {
    updateOntimeFrameSrc();
    updateGoogleSheetsFrame();
    updateTallyFrame();
    updateCustomTabsList();
  });
</script>
</body>
</html>
